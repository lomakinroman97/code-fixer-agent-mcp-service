# CodeFixerAgent

MCP-сервер для автоматического исправления ошибок в коде с использованием Yandex GPT.

## Описание

CodeFixerAgent - это серверное приложение, которое выступает в роли интеллектуального агента между клиентом и Large Language Model (LLM). Сервер принимает описание бага и имя файла, находит соответствующий файл в локальной кодовой базе, оптимизирует его содержимое для экономии токенов, отправляет запрос в LLM для исправления ошибки и возвращает клиенту исправленный код.

## ✅ Статус проекта

**ПРОЕКТ УСПЕШНО СОЗДАН И ПРОТЕСТИРОВАН!**

- ✅ HTTP API работает корректно
- ✅ Интеграция с Yandex GPT API настроена
- ✅ Оптимизация кода (удаление комментариев, сжатие) работает
- ✅ Обработка ошибок настроена
- ✅ Логирование настроено
- ✅ Docker конфигурация готова

## Технологии

- **Язык**: Kotlin
- **Фреймворк**: Ktor
- **HTTP-клиент**: Ktor Client
- **JSON-парсинг**: kotlinx.serialization
- **Управление зависимостями**: Gradle (Kotlin DSL)
- **Контейнеризация**: Docker

## Требования

- Java 17 или выше
- Gradle 9.0.0 или выше
- Docker (опционально)

## Установка и запуск

### Локальный запуск

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd code-fixer-agent
```

2. Соберите проект:
```bash
./gradlew build
```

3. Запустите приложение:
```bash
./gradlew run
```

Приложение будет доступно по адресу: http://localhost:8080

### Запуск через Docker

1. Соберите Docker образ:
```bash
docker build -t codefixer-agent .
```

2. Запустите контейнер:
```bash
docker run -p 8080:8080 \
  -v /Users/lomakin_r/AndroidStudioProjects/chat_llm_code_helper:/Users/lomakin_r/AndroidStudioProjects/chat_llm_code_helper:ro \
  codefixer-agent
```

### Запуск через Docker Compose

```bash
docker-compose up -d
```

## API Endpoints

### POST /api/fix

Исправляет ошибки в указанном файле.

**Request Body:**
```json
{
  "file_path": "app/src/main/java/com/example/chat_llm_code_helper/ui/components/LoadingIndicator.kt",
  "bug_description": "Проверка работы API с маленьким файлом"
}
```

**Response (Success - 200 OK):**
```json
{
  "status": "success",
  "fixed_code": "...\n...исправленный код...\n..."
}
```

**Response (Error - 4xx/5xx):**
```json
{
  "status": "error",
  "message": "File not found: app/src/main/java/com/example/chat_llm_code_helper/ui/components/LoadingIndicator.kt"
}
```

### GET /health

Проверка состояния сервера.

**Response:**
```
OK
```

## Конфигурация

### Корневая директория кодовой базы

По умолчанию сервер настроен на работу с директорией:
```
/Users/lomakin_r/AndroidStudioProjects/chat_llm_code_helper/
```

Для изменения этой директории отредактируйте параметр `rootDirectory` в классе `FileService`.

### Yandex GPT API

Сервер использует предустановленный API ключ для Yandex GPT. Для изменения ключа отредактируйте параметр `apiKey` в классе `YandexGptService`.

### Таймауты

Настроены увеличенные таймауты для работы с большими файлами:
- Запрос: 5 минут
- Подключение: 30 секунд
- Сокет: 5 минут

### Ограничения размера файла

По умолчанию файлы обрезаются до 4000 символов для экономии токенов. Это значение можно изменить в `FileService.maxFileSize`.

## Алгоритм работы

1. **Прием запроса**: Сервер принимает POST-запрос на `/api/fix`
2. **Валидация**: Проверяет корректность полей `file_path` и `bug_description`
3. **Поиск файла**: Строит абсолютный путь и проверяет существование файла
4. **Чтение и оптимизация**: Читает содержимое файла и применяет минимизацию:
   - Удаляет комментарии (// и /* ... */)
   - Удаляет лишние пустые строки
   - Обрезает файлы больше 4000 символов
5. **Формирование промпта**: Создает структурированный запрос для LLM
6. **Отправка в Yandex GPT**: Передает оптимизированный код и описание ошибки
7. **Возврат результата**: Возвращает исправленный код клиенту

## Тестирование

Проект протестирован на реальном файле `LoadingIndicator.kt` (984 символа):

```
✅ Файл найден и прочитан
✅ Код оптимизирован (942 символа)
✅ Запрос отправлен в Yandex GPT
✅ LLM вернул исправленный код
✅ API ответил статусом "success"
```

## Логирование

Логи сохраняются в:
- Консоль (STDOUT)
- Файл: `logs/codefixer.log`

Уровень логирования по умолчанию: INFO

## Мониторинг

Сервер включает health check endpoint для мониторинга состояния:
- URL: `/health`
- Проверка каждые 30 секунд (в Docker)
- Таймаут: 10 секунд

## Безопасность

- Сервер принимает запросы только на localhost (0.0.0.0:8080)
- Доступ к файловой системе ограничен указанной корневой директорией
- API ключ Yandex GPT встроен в код (в продакшене рекомендуется использовать переменные окружения)

## Разработка

### Структура проекта

```
src/main/kotlin/com/codefixer/
├── models/          # Модели данных
├── services/        # Бизнес-логика
├── routes/          # HTTP роуты
└── Application.kt   # Точка входа
```

### Добавление новых функций

1. Создайте новый сервис в папке `services/`
2. Добавьте соответствующие модели в `models/`
3. Создайте роуты в `routes/`
4. Обновите `Application.kt`

## Известные ограничения

- Файлы автоматически обрезаются до 4000 символов
- Требуется стабильное интернет-соединение для работы с Yandex GPT API
- API ключ Yandex GPT должен быть действительным

## Лицензия

Проект разработан в соответствии с техническим заданием.
